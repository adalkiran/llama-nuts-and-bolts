
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A holistic way of understanding how Llama and its components run in practice, with code and detailed documentation.">
      
      
        <meta name="author" content="Adil Alper DALKIRAN">
      
      
        <link rel="canonical" href="https://adalkiran.github.io/llama-nuts-and-bolts/10-ROPE-ROTARY-POSITIONAL-EMBEDDINGS/">
      
      
        <link rel="prev" href="../09-IMPLEMENTING-LLAMA-MODEL-ARCHITECTURE/">
      
      
        <link rel="next" href="../11-ASKING-FOR-USER-INPUT/">
      
      
      <link rel="icon" href="../assets/icon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.31">
    
    
      
        <title>RoPE (ROTARY POSITIONAL EMBEDDINGS) - Llama Nuts and Bolts</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.3cba04c6.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-05VMCF3NF0"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-05VMCF3NF0",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-05VMCF3NF0",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="RoPE (ROTARY POSITIONAL EMBEDDINGS) - Llama Nuts and Bolts" >
      
        <meta  property="og:description"  content="A holistic way of understanding how Llama and its components run in practice, with code and detailed documentation." >
      
        <meta  property="og:image"  content="https://adalkiran.github.io/llama-nuts-and-bolts/assets/images/social/10-ROPE-ROTARY-POSITIONAL-EMBEDDINGS.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://adalkiran.github.io/llama-nuts-and-bolts/10-ROPE-ROTARY-POSITIONAL-EMBEDDINGS/" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="RoPE (ROTARY POSITIONAL EMBEDDINGS) - Llama Nuts and Bolts" >
      
        <meta  name="twitter:description"  content="A holistic way of understanding how Llama and its components run in practice, with code and detailed documentation." >
      
        <meta  name="twitter:image"  content="https://adalkiran.github.io/llama-nuts-and-bolts/assets/images/social/10-ROPE-ROTARY-POSITIONAL-EMBEDDINGS.png" >
      
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#10-rope-rotary-positional-embeddings" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Llama Nuts and Bolts" class="md-header__button md-logo" aria-label="Llama Nuts and Bolts" data-md-component="logo">
      
  <img src="../assets/icon.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Llama Nuts and Bolts
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              RoPE (ROTARY POSITIONAL EMBEDDINGS)
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9h-1.9M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69m-9.15 3.96h2.3L12 9l-1.15 3.65Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/adalkiran/llama-nuts-and-bolts" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    adalkiran/llama-nuts-and-bolts
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href=".." class="md-tabs__link">
          
  
  Llama Nuts and Bolts

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../webrtc-nuts-and-bolts" class="md-tabs__link">
        
  
    
  
  WebRTC Nuts and Bolts

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="https://www.linkedin.com/in/alper-dalkiran/" class="md-tabs__link">
        
  
    
  
  Contact

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Llama Nuts and Bolts" class="md-nav__button md-logo" aria-label="Llama Nuts and Bolts" data-md-component="logo">
      
  <img src="../assets/icon.svg" alt="logo">

    </a>
    Llama Nuts and Bolts
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/adalkiran/llama-nuts-and-bolts" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    adalkiran/llama-nuts-and-bolts
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Llama Nuts and Bolts
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Llama Nuts and Bolts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    HOME
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../00-THE-JOURNEY/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    THE JOURNEY
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../01-INITIALIZATION/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    INITIALIZATION
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../02-LOADING-TORCH-MODEL/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LOADING TORCH MODEL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../03-LOADING-TORCH-MODEL-DETAILS/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LOADING TORCH MODEL (DETAILS)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../04-LOADING-MODEL-ARGS/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LOADING MODEL ARGS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../05-LOADING-TOKENIZER-MODEL/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LOADING TOKENIZER MODEL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../06-OBSOLETE-LOADING-LLAMA-2-TOKENIZER-MODEL/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OBSOLETE - LOADING LLAMA 2 TOKENIZER MODEL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../07-BFLOAT16-DATA-TYPE/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BFLOAT16 DATA TYPE
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../08-TENSOR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TENSOR
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../09-IMPLEMENTING-LLAMA-MODEL-ARCHITECTURE/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    IMPLEMENTING LLAMA MODEL ARCHITECTURE
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    RoPE (ROTARY POSITIONAL EMBEDDINGS)
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    RoPE (ROTARY POSITIONAL EMBEDDINGS)
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#101-preliminary-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      10.1. Preliminary Concepts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#102-introduction-to-precomputing-the-frequency-tensor" class="md-nav__link">
    <span class="md-ellipsis">
      10.2. Introduction to Precomputing The Frequency Tensor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#103-initiating-angles-of-frequency-tensor" class="md-nav__link">
    <span class="md-ellipsis">
      10.3. Initiating Angles of Frequency Tensor
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#104-getting-outer-product-of-frequency-tensor-and-position-indices" class="md-nav__link">
    <span class="md-ellipsis">
      10.4. Getting Outer Product of Frequency Tensor and Position Indices
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#105-calculating-frequency-tensor-as-cis-polar-coordinates" class="md-nav__link">
    <span class="md-ellipsis">
      10.5. Calculating Frequency Tensor as Cis (Polar Coordinates)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#106-the-result" class="md-nav__link">
    <span class="md-ellipsis">
      10.6. The result
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#107-visualized-form-of-some-samples-from-the-frequency-tensor" class="md-nav__link">
    <span class="md-ellipsis">
      10.7. Visualized Form of Some Samples from The Frequency Tensor
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../11-ASKING-FOR-USER-INPUT/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ASKING FOR USER INPUT
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../12-TOKENIZATION/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TOKENIZATION
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../13-GENERATING-NEXT-TOKENS/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GENERATING NEXT TOKENS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../14-MAKING-PREDICTION-WITH-LLAMA-MODEL-1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MAKING PREDICTION with LLAMA MODEL - 1
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../15-MAKING-PREDICTION-WITH-LLAMA-MODEL-2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MAKING PREDICTION with LLAMA MODEL - 2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../16-MAKING-PREDICTION-WITH-LLAMA-MODEL-3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MAKING PREDICTION with LLAMA MODEL - 3
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../17-UNICODE-UTF-8-EMOJIS/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    UNICODE, UTF-8 and EMOJIS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../18-CONCLUSION/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CONCLUSION
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../19-REFERENCES/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    REFERENCES
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../20-DIAGRAMS/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DIAGRAMS
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../webrtc-nuts-and-bolts" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    WebRTC Nuts and Bolts
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://www.linkedin.com/in/alper-dalkiran/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contact
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="10-rope-rotary-positional-embeddings"><strong>10. RoPE (ROTARY POSITIONAL EMBEDDINGS)</strong><a class="headerlink" href="#10-rope-rotary-positional-embeddings" title="Permanent link">&para;</a></h1>
<p>The Llama model uses RoPE (Rotary Positional Embeddings) alongside the standard embedding layer to highlight the influence of token positions within a sequence.</p>
<p>For decades, <em>embedding</em> has been the most commonly used technique to represent words, concepts, or tokens in NLP (Natural Language Processing) world. Typically, an embedding model is trained to let them learn frequencies of use of tokens together. The tokens are placed in suitable positions within a multi-dimensional space, where distances reflect the difference or similarity between them.</p>
<p>There are a wide variety of different methods to implement embeddings. Some of them take token positions into account.</p>
<p>Taking the token positions into account is important. Think of, two sentences containing exactly the same words in different orders. If you don't take the positions into account, your system handles these two sentences (despite with different meanings) as the same thing.</p>
<h2 id="101-preliminary-concepts"><strong>10.1. Preliminary Concepts</strong><a class="headerlink" href="#101-preliminary-concepts" title="Permanent link">&para;</a></h2>
<p>Let's try to explain with an example. Think of, we have a sequence of 5 tokens and an embedding layer with the shape of <code>{128256, 4096}</code>. So, we have:</p>
<ul>
<li>A token embedding sequence which was calculated using the embedding layer. Our input tensor will be with the shape of <code>{5, 4096}</code>,</li>
<li>We have <code>32</code> "attention heads" (according to <code>modelArgs.N_Heads = 32</code>). Our each attention head will have a dimension <code>modelArgs.Dim / modelArgs.N_Heads</code>. In our case, it is <code>4096 / 32 = 128</code>. So our positional embedding tensors will have <code>128</code> dimensions.</li>
<li>We have an array of position indices of the tokens: <code>{1, 2, 3, 4, 5}</code>.</li>
</ul>
<p>We have several alternatives to calculate the positional embeddings. Some of them are:</p>
<ul>
<li>Taking the positions as they are: <code>{0, 1, 2, 3, 4}</code>,</li>
<li>Taking the positions in normalized values between <code>0</code> and <code>1</code> as <code>{0., 0.25, 0.50, 0.75, 1.}</code>,</li>
<li>
<p>As suggested in the paper <a href="https://arxiv.org/abs/1706.03762" target="_blank">Attention Is All You Need</a>, using sinusoidal functions. Each dimension of the positional encoding corresponds to a sinusoid:</p>
<div class="arithmatex">\[
\begin{gathered}
    PE_(pos,2i) = \sin(pos/10000^\frac{2i}{d_{model}}) \\
    PE_(pos,2i+1) = \cos(pos/10000^\frac{2i}{d_{model}})
\end{gathered}
\]</div>
<p>This means that, we have <code>128</code> dimensions for each position, <code>i</code> will loop from <code>0</code> to <code>64</code> (half of <code>128</code>).</p>
<p>The original paper suggests using <code>10000</code> as base theta value, and the Llama 2 model uses this value. But newer versions of Llama (3 and higher) started to use <code>500000</code> as base theta value, so, we will stick to using <code>500000</code>.</p>
<p><strong><u>Update with Llama 3.1:</u></strong> The Llama 3.1 version comes with a small adjustment on frequencies. <a href="https://github.com/meta-llama/llama-models/blob/f45cdfd624b98b6655540f7101d8d9cb432e631c/models/llama3_1/reference_impl/model.py#L45" target="_blank">apply_scaling(...)</a> method was added into original Llama 3.1 implementation, that calculates wavelengths from these frequencies and applies some limitations on them. Implementation detail will be discussed in the following subchapters. Currently we represent this operation with <code>scl(...)</code>.</p>
<p>Our <code>PE</code> positional embedding array for <code>3th</code> position will be like:</p>
<div class="arithmatex">\[
\begin{gathered}
    PE = \left\lbrace
    \begin{array}{l}
    \sin\left(scl\left(\frac{3}{500000^\frac{0}{128}}\right)\right),
    \cos\left(scl\left(\frac{3}{500000^\frac{0}{128}}\right)\right),
    \sin\left(scl\left(\frac{3}{500000^\frac{2}{128}}\right)\right),
    \cos\left(scl\left(\frac{3}{500000^\frac{2}{128}}\right)\right), \\
    \dots, \\
    \sin\left(scl\left(\frac{3}{500000^\frac{124}{128}}\right)\right),
    \cos\left(scl\left(\frac{3}{500000^\frac{124}{128}}\right)\right),
    \sin\left(scl\left(\frac{3}{500000^\frac{126}{128}}\right)\right),
    \cos\left(scl\left(\frac{3}{500000^\frac{126}{128}}\right)\right)
    \end{array}
    \right\rbrace \\
\end{gathered}
\]</div>
</li>
<li>
<p>As suggested in the paper <a href="https://arxiv.org/abs/2104.09864v5" target="_blank">RoFormer</a>, using sinusoidal functions in slightly different ways, as described following parts,</p>
</li>
<li>Using the output of a custom function that takes the position indices as input.</li>
</ul>
<p>We have several alternatives to integrate the positional embeddings with the token embedding vectors. If our positional embedding vectors and the token embedding vectors both have same dimension, we can sum or multiply them:</p>
<ul>
<li>Summation: As suggested in the paper <a href="https://arxiv.org/abs/1706.03762" target="_blank">Attention Is All You Need</a> too, we can simply add two vectors as <code>new_embeddings = token_embeddings + positional_embeddings</code>,</li>
<li>Multiplication: As suggested in the paper <a href="https://arxiv.org/abs/2104.09864v5" target="_blank">RoFormer</a> too, we can simply multiply element-wise two vectors as <code>new_embeddings = token_embeddings * positional_embeddings</code>.</li>
</ul>
<p>Think of, we can take the positions as they are, <code>{0, 1, 2, 3, 4}</code>, and add them with each dimension of our embedding vectors. It may work, but sounds not so much meaningful, right? So, we need to find a more meaningful method.</p>
<p>You can find some introduction for <em>absolute position embedding</em> and <em>relative position embedding</em> in the paper <a href="https://arxiv.org/abs/2104.09864v5" target="_blank">RoFormer</a> alongside the proposed approach <em>RoPE (Rotary Positional Embeddings)</em> by the same paper.</p>
<p>The main idea behind these approaches is to let the model effectively take into account token positions. <em>RoPE (Rotary Positional Embeddings)</em> approach represents the positions of tokens in the polar coordinate system, which employs angles and complex numbers.</p>
<p>With this approach, we have a chance to combine multiple approaches and we have the following advantages:</p>
<ul>
<li>To distribute our positional embeddings in the space in a limited range (<code>[-1, +1]</code> because of limits of <code>cos</code> and <code>sin</code> functions),</li>
<li>Other approaches prefer summation to integrate the positional embeddings with the token embedding vectors. However, the summation corrupts the exact data that the vector has. But in this approach, we prefer multiplication. And the value we multiply is a sinusoidal function, a sinusoid, we can think that we are only <strong><em>rotating</em></strong> the original embedding vector by an angle. So, theoretically, we don't corrupt the original data,</li>
<li>In the approach of <a href="https://arxiv.org/abs/2104.09864v5" target="_blank">RoFormer</a> that we used in this project, takes the items of <code>128</code> dimension of an attention head as <code>64</code> pairs. Then, it obtains a complex number from each pair by taking the first item of the pair as <em>real part</em> and the second item of the pair as <em>imaginary part</em> of a complex number.</li>
</ul>
<div class="arithmatex">\[
\begin{gathered}
    \text{where }i^2=-1, i\text{ is the imaginary unit,} \\
    out = abs \cdot \cos(angle) + abs \cdot \sin(angle) \cdot i
\end{gathered}
\]</div>
<ul>
<li>Taking the items of an attention head as float pairs and representing them as complex numbers in polar coordinate system makes our method more suitable for its mathematical nature. Also, this allows it to represent these complex numbers as a matrix, which allows us to perform matrix operations.</li>
<li>With this approach, the influence of position on embeddings is high for lower dimensions (going from the first dimension throughout 128 dimensions) and converges to zero for higher dimensions. This makes higher dimensions of embeddings less sensitive to positional data than lower dimensions. Because the polar coordinates calculated for higher dimensions are nearly the same value.
    &gt;<strong>Important note:</strong> I read it in a few sources then I saw it with the 3D charts that I drew in the notebook <a href="https://github.com/adalkiran/llama-nuts-and-bolts/blob/main/docs/10.BONUS-PRECOMPUTING-FREQUENCY-TENSOR.ipynb" target="_blank">10.BONUS-PRECOMPUTING-FREQUENCY-TENSOR.ipynb</a>, also can be found the bottom of this chapter.</li>
</ul>
<blockquote>
<p>Note: In this approach, some concepts from computing, mathematics, geometry, and physics were combined. For example, we can think that:</p>
<ul>
<li>Our positions are points in a time series,</li>
<li>Our positional encoding function as <em>a function with respect to time</em>, so we can say it is a signal,</li>
<li>Our angles as <em>angular frequency</em> (<span class="arithmatex">\({\displaystyle \omega }\)</span>) and our positions as <em>real independent variable/time</em> of a sine wave.</li>
</ul>
</blockquote>
<p>In the following subchapters, we will see how these polar coordinates are precalculated. These values don't vary by input, so this calculation is made only once.</p>
<p>Sources:</p>
<ul>
<li><a href="https://www.turing.com/kb/guide-on-word-embeddings-in-nlp" target="_blank">A Guide on Word Embeddings in NLP</a></li>
<li><a href="https://www.theaidream.com/post/word-embeddings-in-natural-language-processing-nlp" target="_blank">Word Embeddings in Natural Language Processing(NLP)</a></li>
<li><a href="https://arxiv.org/abs/2104.09864v5" target="_blank">RoFormer: Enhanced Transformer with Rotary Position Embedding Paper</a></li>
<li><a href="https://www.youtube.com/watch?v=GQPOtyITy54" target="_blank">Youtube - RoPE (Rotary positional embeddings) explained: The positional workhorse of modern LLMs</a></li>
<li><a href="https://www.youtube.com/watch?v=Mn_9W1nCFLo&t=1471s" target="_blank">Youtube - Llama explained... - "Rotary Positional Embeddings" section</a></li>
</ul>
<h2 id="102-introduction-to-precomputing-the-frequency-tensor"><strong>10.2. Introduction to Precomputing The Frequency Tensor</strong><a class="headerlink" href="#102-introduction-to-precomputing-the-frequency-tensor" title="Permanent link">&para;</a></h2>
<blockquote>
<p>You can check out the following for more information:</p>
<ul>
<li>The Python codes that create the sample data and graphs used here with this Python Notebook: <a href="https://github.com/adalkiran/llama-nuts-and-bolts/blob/main/docs/10.BONUS-PRECOMPUTING-FREQUENCY-TENSOR.ipynb" target="_blank">10.BONUS-PRECOMPUTING-FREQUENCY-TENSOR.ipynb</a>.</li>
<li><a href="https://machinelearningmastery.com/a-gentle-introduction-to-positional-encoding-in-transformer-models-part-1/" target="_blank">A Gentle Introduction to Positional Encoding in Transformer Models, Part 1</a> article.</li>
</ul>
</blockquote>
<p>The <a href="https://github.com/adalkiran/llama-nuts-and-bolts/blob/main/src/model/llamatransformer.go" target="_blank">precomputeFreqsCis(...)</a> function takes four arguments: <code>dim</code>, <code>end</code>, <code>theta</code>, and <code>useScaled</code>.</p>
<p>The argument <code>dim</code> is computed as <code>int(modelArgs.Dim/modelArgs.N_Heads)</code>, <code>end</code> is computed as <code>modelArgs.MaxSequenceLength*2</code>, <code>theta</code> is <code>modelArgs.RopeTheta</code>, <code>useScaled</code> is <code>modelArgs.UseScaledRope</code>. In our case, <code>dim = 4096/32 = 128</code>,  <code>end = 2048 * 2 = 4096</code>, <code>theta = 500000</code>, <code>useScaled = true</code>.</p>
<p>In our case, the <a href="https://github.com/adalkiran/llama-nuts-and-bolts/blob/main/src/model/llamatransformer.go" target="_blank">precomputeFreqsCis(...)</a> function is called with <code>dim = 128</code>, <code>end = 4096</code>, <code>theta = 500000</code>, and <code>useScaled = true</code>.</p>
<p><sup>from <a href="https://github.com/adalkiran/llama-nuts-and-bolts/blob/main/src/model/llamatransformer.go" target="_blank">src/model/llamatransformer.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">NewLlamaTransformer</span><span class="p">(</span><span class="nx">model</span><span class="w"> </span><span class="o">*</span><span class="nx">Model</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">LlamaTransformer</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">    </span><span class="nx">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">LlamaTransformer</span><span class="p">{}</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">    </span><span class="o">...</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">PrecomputedFreqsCis</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">precomputeFreqsCis</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nx">dim</span><span class="o">/</span><span class="nx">modelArgs</span><span class="p">.</span><span class="nx">N_Heads</span><span class="p">),</span><span class="w"> </span><span class="nx">modelArgs</span><span class="p">.</span><span class="nx">MaxSequenceLength</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">modelArgs</span><span class="p">.</span><span class="nx">RopeTheta</span><span class="p">,</span><span class="w"> </span><span class="nx">modelArgs</span><span class="p">.</span><span class="nx">UseScaledRope</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">    </span><span class="o">...</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="p">}</span>
</span></code></pre></div>
<h2 id="103-initiating-angles-of-frequency-tensor"><strong>10.3. Initiating Angles of Frequency Tensor</strong><a class="headerlink" href="#103-initiating-angles-of-frequency-tensor" title="Permanent link">&para;</a></h2>
<p>In the <a href="https://github.com/meta-llama/llama-models/blob/f45cdfd624b98b6655540f7101d8d9cb432e631c/models/llama3_1/reference_impl/model.py#L70" target="_blank">original Llama 3.1 Python repository of Meta</a>, this Python code initiates the <code>freqs</code> array:</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">import</span> <span class="nn">torch</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="k">def</span> <span class="nf">precompute_freqs_cis</span><span class="p">(</span><span class="n">dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">theta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10000.0</span><span class="p">,</span> <span class="n">use_scaled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    <span class="o">...</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>    <span class="n">freqs</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">theta</span> <span class="o">**</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">2</span><span class="p">)[:</span> <span class="p">(</span><span class="n">dim</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)]</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">/</span> <span class="n">dim</span><span class="p">))</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>    <span class="o">...</span>
</span></code></pre></div>
<blockquote>
<p><strong>Important note:</strong> The <code>theta</code> variables in both Go and Python code are not an angle. They are explained as: <em>"Scaling factor for frequency computation. Defaults to 10000.0, but in our case, this value comes as 500000.0 for Llama 3.1."</em>.<br>
Instead, the <code>freqs</code> is an array of angles, that corresponds to <span class="arithmatex">\(\Theta\)</span> and each item of <code>freqs</code> array corresponds to <span class="arithmatex">\(\theta_i\)</span> below.<br>
Personally, at first sight, I was confused why they called <em>scaling factor</em> as <code>theta</code> which is a term that made me think <em>it is an angle</em>, but it isn't, items of the <code>freqs</code> are in an angle unit (radians), but at the end, they are only premise value (scaling factor) for the real angles!</p>
</blockquote>
<p>The original equation in section "3.2.2 General form" of <a href="https://arxiv.org/abs/2104.09864" target="_blank">RoFormer: Enhanced Transformer with Rotary Position Embedding</a>:</p>
<div class="arithmatex">\[
\begin{gathered}
\Theta = \left\lbrace \theta_i =  10000^{-\frac{2(i - 1)}{dim}}, i \in [1, 2, \dots, \frac{dim}{2}] \right\rbrace
\end{gathered}
\]</div>
<p>If we expand it for <code>dim=128</code> and use <code>500000</code> instead of <code>10000</code> in our case:</p>
<div class="arithmatex">\[
\begin{gathered}
\Theta = \left\lbrace
  \theta_1 = 500000^{-\frac{2(1 - 1)}{128}},
  \theta_2 = 500000^{-\frac{2(2 - 1)}{128}},
  \theta_3 = 500000^{-\frac{2(3 - 1)}{128}},
  \dots,
  \theta_{63} = 500000^{-\frac{2(63 - 1)}{128}},
  \theta_{64} = 500000^{-\frac{2(64 - 1)}{128}}
\right\rbrace \\
= \\
\Theta = \left\lbrace
  \theta_1 = 500000^{-\frac{0}{128}},
  \theta_2 = 500000^{-\frac{2}{128}},
  \theta_3 = 500000^{-\frac{4}{128}},
  \dots,
  \theta_{63} = 500000^{-\frac{124}{128}},
  \theta_{64} = 500000^{-\frac{126}{128}}
\right\rbrace \\
= \\
\Theta = \left\lbrace
  \theta_1 = \frac{1}{500000^{\frac{0}{128}}},
  \theta_2 = \frac{1}{500000^{\frac{2}{128}}},
  \theta_3 = \frac{1}{500000^{\frac{4}{128}}},
  \dots,
  \theta_{63} = \frac{1}{500000^{\frac{124}{128}}},
  \theta_{64} = \frac{1}{500000^{\frac{126}{128}}}
\right\rbrace
\end{gathered}
\]</div>
<p><strong><u>Update with Llama 3.1:</u></strong> The Llama 3.1 version comes with a small adjustment on frequencies. Implementation detail will be discussed in the following subchapters. Currently we represent this operation with <code>scl(...)</code>.</p>
<p>If it will be expressed with variable names in the code and scaling is applied:</p>
<div class="arithmatex">\[
\begin{gathered}
freqs =
\left\lbrace
    \text{item}_{i} = scl\left(\frac{1}{theta^{\frac{val}{dim}}}\right)
\right\rbrace
, val \in \lbrack0, 2, 4, ...,dim - 2\rbrack
, i \in \left[0, 1, 2, ..., \frac{dim}{2} -1\right] \\
\\
\\
\text{freqs} =
\left\lbrace
    \text{item}_0 = scl\left(\frac{1}{500000^{\frac{0}{128}}}\right),
    \text{item}_1 = scl\left(\frac{1}{500000^{\frac{2}{128}}}\right),
    \text{item}_2 = scl\left(\frac{1}{500000^{\frac{4}{128}}}\right),
    \dots,
    \text{item} _{62} = scl\left(\frac{1}{500000^{\frac{124}{128}}}\right),
    \text{item} _{63} = scl\left(\frac{1}{500000^{\frac{126}{128}}}\right)
\right\rbrace
\end{gathered}
\]</div>
<p>You can find original Python implementation of <a href="https://github.com/meta-llama/llama-models/blob/f45cdfd624b98b6655540f7101d8d9cb432e631c/models/llama3_1/reference_impl/model.py#L45" target="_blank">apply_scaling(...)</a> function which is represented as <span class="arithmatex">\(scl\left(...\right)\)</span> here.</p>
<p><sup>from <a href="https://github.com/adalkiran/llama-nuts-and-bolts/blob/main/src/model/llamatransformer.go" target="_blank">src/model/llamatransformer.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">applyScaling</span><span class="p">(</span><span class="nx">freqs</span><span class="w"> </span><span class="o">*</span><span class="nx">ml</span><span class="p">.</span><span class="nx">Tensor</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w">    </span><span class="c1">// See Llama 3.1 Code: https://github.com/meta-llama/llama-models/blob/f45cdfd624b98b6655540f7101d8d9cb432e631c/models/llama3_1/reference_impl/model.py#L45</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="c1">// Values obtained from grid search</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="nx">scaleFactor</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">float32</span><span class="p">(</span><span class="mf">8.0</span><span class="p">)</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="nx">lowFreqFactor</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">float32</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span><span class="nx">highFreqFactor</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">float32</span><span class="p">(</span><span class="mf">4.0</span><span class="p">)</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="nx">oldContextLen</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">float32</span><span class="p">(</span><span class="mi">8192</span><span class="p">)</span><span class="w"> </span><span class="c1">// original llama3 length</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span><span class="nx">lowFreqWavelen</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">oldContextLen</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">lowFreqFactor</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">    </span><span class="nx">highFreqWavelen</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">oldContextLen</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">highFreqFactor</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">freqs</span><span class="p">.</span><span class="nx">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">        </span><span class="nx">freq</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">freqs</span><span class="p">.</span><span class="nx">GetItem_AsFloat32</span><span class="p">([]</span><span class="kt">int</span><span class="p">{</span><span class="nx">i</span><span class="p">})</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">newFreq</span><span class="w"> </span><span class="kt">float32</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="w">        </span><span class="nx">wavelen</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">math</span><span class="p">.</span><span class="nx">Pi</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">freq</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">wavelen</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">highFreqWavelen</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="w">            </span><span class="nx">newFreq</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">freq</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">wavelen</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">lowFreqWavelen</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="w">            </span><span class="nx">newFreq</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">freq</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">scaleFactor</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="w">            </span><span class="nx">smooth</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">(</span><span class="nx">oldContextLen</span><span class="o">/</span><span class="nx">wavelen</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">lowFreqFactor</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="nx">highFreqFactor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">lowFreqFactor</span><span class="p">)</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="w">            </span><span class="nx">newFreq</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="nx">smooth</span><span class="p">)</span><span class="o">*</span><span class="nx">freq</span><span class="o">/</span><span class="nx">scaleFactor</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">smooth</span><span class="o">*</span><span class="nx">freq</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">freqs</span><span class="p">.</span><span class="nx">SetItem_FromFloat32</span><span class="p">([]</span><span class="kt">int</span><span class="p">{</span><span class="nx">i</span><span class="p">},</span><span class="w"> </span><span class="nx">newFreq</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a><span class="p">}</span>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="kd">func</span><span class="w"> </span><span class="nx">precomputeFreqsCis</span><span class="p">(</span><span class="nx">dim</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">theta</span><span class="w"> </span><span class="kt">float64</span><span class="p">,</span><span class="w"> </span><span class="nx">useScaled</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">ml</span><span class="p">.</span><span class="nx">Tensor</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a><span class="w">    </span><span class="o">...</span>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a><span class="w">    </span><span class="nx">dimFloat</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">float32</span><span class="p">(</span><span class="nx">dim</span><span class="p">)</span>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a><span class="w">    </span><span class="nx">freqs</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ml</span><span class="p">.</span><span class="nx">ARange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">dim</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">ml</span><span class="p">.</span><span class="nx">DT_BF16</span><span class="p">)</span>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a><span class="w">    </span><span class="o">...</span>
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a><span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">freqs</span><span class="p">.</span><span class="nx">Apply_AsFloat32</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">val</span><span class="w"> </span><span class="kt">float32</span><span class="p">)</span><span class="w"> </span><span class="kt">float32</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">float32</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">math</span><span class="p">.</span><span class="nx">Pow</span><span class="p">(</span><span class="nx">theta</span><span class="p">,</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="nx">val</span><span class="o">/</span><span class="nx">dimFloat</span><span class="p">)))</span>
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-2-41"><a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a><span class="w">    </span><span class="o">...</span>
</span><span id="__span-2-42"><a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">useScaled</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-43"><a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a><span class="w">        </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">applyScaling</span><span class="p">(</span><span class="nx">freqs</span><span class="p">)</span>
</span><span id="__span-2-44"><a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-45"><a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-2-46"><a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-2-47"><a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-2-48"><a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a><span class="w">    </span><span class="o">...</span>
</span><span id="__span-2-49"><a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a><span class="p">}</span>
</span></code></pre></div>
<p>Go project (ours) values of the <code>freqs</code> array:</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nt">freqs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nv">0</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">4</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">6</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">8</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">10</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">12</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">...</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">124</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">126</span><span class="p p-Indicator">}</span><span class="w"> </span><span class="c1"># has 64 items, at this time, the freqs array contains &quot;val&quot; values that exists in the equations above.</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="c1"># after running Apply_AsFloat32 and then applyScaling, freqs will be:</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="nt">freqs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="c1"># has 64 items, in radians.</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="nv">1.0000e+00</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">8.1250e-01</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">6.6016e-01</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5.3906e-01</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">4.3945e-01</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3.5742e-01</span><span class="p p-Indicator">,</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">    </span><span class="nv">2.9102e-01</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2.3730e-01</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.9336e-01</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.5723e-01</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.2793e-01</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.0449e-01</span><span class="p p-Indicator">,</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="nv">8.4961e-02</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">6.9336e-02</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5.6641e-02</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">4.6143e-02</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3.7598e-02</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3.0518e-02</span><span class="p p-Indicator">,</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">    </span><span class="nv">2.4902e-02</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2.0264e-02</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.6479e-02</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.3489e-02</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.0986e-02</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">8.9111e-03</span><span class="p p-Indicator">,</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">    </span><span class="nv">7.2632e-03</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5.9204e-03</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">4.8218e-03</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3.9368e-03</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3.2043e-03</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2.1515e-03</span><span class="p p-Indicator">,</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="w">    </span><span class="nv">1.3504e-03</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">8.5068e-04</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5.1880e-04</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3.1090e-04</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.7834e-04</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">9.5367e-05</span><span class="p p-Indicator">,</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">    </span><span class="nv">7.7724e-05</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">6.2943e-05</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5.1498e-05</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">4.1962e-05</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3.4094e-05</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2.7895e-05</span><span class="p p-Indicator">,</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="w">    </span><span class="nv">2.2650e-05</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.8477e-05</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.5080e-05</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.2279e-05</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.0014e-05</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">8.1062e-06</span><span class="p p-Indicator">,</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="w">    </span><span class="nv">6.6459e-06</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">5.3942e-06</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">4.4107e-06</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3.5912e-06</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2.9206e-06</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">2.3842e-06</span><span class="p p-Indicator">,</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="w">    </span><span class="nv">1.9372e-06</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.5795e-06</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.2890e-06</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">1.0431e-06</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">8.5309e-07</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">6.9663e-07</span><span class="p p-Indicator">,</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="w">    </span><span class="nv">5.6624e-07</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">4.6194e-07</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3.7625e-07</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">3.0547e-07</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="p p-Indicator">}</span>
</span></code></pre></div>
<p>This is the output of Python + Pytorch environment. There are slight differences between them because of floating point precision differences.</p>
<p>In the table below, you can find approximate equivalents of radian angle values in degrees, with corresponding "val" indices:</p>
<table>
<thead>
<tr>
<th><strong>val</strong></th>
<th><strong>rad</strong></th>
<th><strong>deg</strong></th>
<th></th>
<th><strong>val</strong></th>
<th><strong>rad</strong></th>
<th><strong>deg</strong></th>
<th></th>
<th><strong>val</strong></th>
<th><strong>rad</strong></th>
<th><strong>deg</strong></th>
<th></th>
<th><strong>val</strong></th>
<th><strong>rad</strong></th>
<th><strong>deg</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>0</strong></td>
<td>1.00000000</td>
<td>57.29578</td>
<td></td>
<td><strong>32</strong></td>
<td>0.03760603</td>
<td>2.15467</td>
<td></td>
<td><strong>64</strong></td>
<td>0.00052485</td>
<td>0.03007</td>
<td></td>
<td><strong>96</strong></td>
<td>0.00000665</td>
<td>0.00038</td>
</tr>
<tr>
<td><strong>2</strong></td>
<td>0.81461722</td>
<td>46.67413</td>
<td></td>
<td><strong>34</strong></td>
<td>0.03063452</td>
<td>1.75523</td>
<td></td>
<td><strong>66</strong></td>
<td>0.00031269</td>
<td>0.01792</td>
<td></td>
<td><strong>98</strong></td>
<td>0.00000542</td>
<td>0.00031</td>
</tr>
<tr>
<td><strong>4</strong></td>
<td>0.66360128</td>
<td>38.02155</td>
<td></td>
<td><strong>36</strong></td>
<td>0.02495541</td>
<td>1.42984</td>
<td></td>
<td><strong>68</strong></td>
<td>0.00017851</td>
<td>0.01023</td>
<td></td>
<td><strong>100</strong></td>
<td>0.00000441</td>
<td>0.00025</td>
</tr>
<tr>
<td><strong>6</strong></td>
<td>0.54058099</td>
<td>30.97301</td>
<td></td>
<td><strong>38</strong></td>
<td>0.02032910</td>
<td>1.16477</td>
<td></td>
<td><strong>70</strong></td>
<td>0.00009556</td>
<td>0.00548</td>
<td></td>
<td><strong>102</strong></td>
<td>0.00000359</td>
<td>0.00021</td>
</tr>
<tr>
<td><strong>8</strong></td>
<td>0.44036663</td>
<td>25.23115</td>
<td></td>
<td><strong>40</strong></td>
<td>0.01656044</td>
<td>0.94884</td>
<td></td>
<td><strong>72</strong></td>
<td>0.00007785</td>
<td>0.00446</td>
<td></td>
<td><strong>104</strong></td>
<td>0.00000293</td>
<td>0.00017</td>
</tr>
<tr>
<td><strong>10</strong></td>
<td>0.35873023</td>
<td>20.55373</td>
<td></td>
<td><strong>42</strong></td>
<td>0.01349042</td>
<td>0.77294</td>
<td></td>
<td><strong>74</strong></td>
<td>0.00006342</td>
<td>0.00363</td>
<td></td>
<td><strong>106</strong></td>
<td>0.00000238</td>
<td>0.00014</td>
</tr>
<tr>
<td><strong>12</strong></td>
<td>0.29222783</td>
<td>16.74342</td>
<td></td>
<td><strong>44</strong></td>
<td>0.01098953</td>
<td>0.62965</td>
<td></td>
<td><strong>76</strong></td>
<td>0.00005166</td>
<td>0.00296</td>
<td></td>
<td><strong>108</strong></td>
<td>0.00000194</td>
<td>0.00011</td>
</tr>
<tr>
<td><strong>14</strong></td>
<td>0.23805381</td>
<td>13.63948</td>
<td></td>
<td><strong>46</strong></td>
<td>0.00895226</td>
<td>0.51293</td>
<td></td>
<td><strong>78</strong></td>
<td>0.00004208</td>
<td>0.00241</td>
<td></td>
<td><strong>110</strong></td>
<td>0.00000158</td>
<td>0.00009</td>
</tr>
<tr>
<td><strong>16</strong></td>
<td>0.19392276</td>
<td>11.11096</td>
<td></td>
<td><strong>48</strong></td>
<td>0.00729267</td>
<td>0.41784</td>
<td></td>
<td><strong>80</strong></td>
<td>0.00003428</td>
<td>0.00196</td>
<td></td>
<td><strong>112</strong></td>
<td>0.00000129</td>
<td>0.00007</td>
</tr>
<tr>
<td><strong>18</strong></td>
<td>0.15797281</td>
<td>9.05118</td>
<td></td>
<td><strong>50</strong></td>
<td>0.00594073</td>
<td>0.34038</td>
<td></td>
<td><strong>82</strong></td>
<td>0.00002793</td>
<td>0.00160</td>
<td></td>
<td><strong>114</strong></td>
<td>0.00000105</td>
<td>0.00006</td>
</tr>
<tr>
<td><strong>20</strong></td>
<td>0.12868738</td>
<td>7.37324</td>
<td></td>
<td><strong>52</strong></td>
<td>0.00483942</td>
<td>0.27728</td>
<td></td>
<td><strong>84</strong></td>
<td>0.00002275</td>
<td>0.00130</td>
<td></td>
<td><strong>116</strong></td>
<td>0.00000086</td>
<td>0.00005</td>
</tr>
<tr>
<td><strong>22</strong></td>
<td>0.10483095</td>
<td>6.00637</td>
<td></td>
<td><strong>54</strong></td>
<td>0.00394228</td>
<td>0.22588</td>
<td></td>
<td><strong>86</strong></td>
<td>0.00001853</td>
<td>0.00106</td>
<td></td>
<td><strong>118</strong></td>
<td>0.00000070</td>
<td>0.00004</td>
</tr>
<tr>
<td><strong>24</strong></td>
<td>0.08539710</td>
<td>4.89289</td>
<td></td>
<td><strong>56</strong></td>
<td>0.00321145</td>
<td>0.18400</td>
<td></td>
<td><strong>88</strong></td>
<td>0.00001510</td>
<td>0.00086</td>
<td></td>
<td><strong>120</strong></td>
<td>0.00000057</td>
<td>0.00003</td>
</tr>
<tr>
<td><strong>26</strong></td>
<td>0.06956595</td>
<td>3.98584</td>
<td></td>
<td><strong>58</strong></td>
<td>0.00216657</td>
<td>0.12414</td>
<td></td>
<td><strong>90</strong></td>
<td>0.00001230</td>
<td>0.00070</td>
<td></td>
<td><strong>122</strong></td>
<td>0.00000046</td>
<td>0.00003</td>
</tr>
<tr>
<td><strong>28</strong></td>
<td>0.05666962</td>
<td>3.24693</td>
<td></td>
<td><strong>60</strong></td>
<td>0.00137189</td>
<td>0.07860</td>
<td></td>
<td><strong>92</strong></td>
<td>0.00001002</td>
<td>0.00057</td>
<td></td>
<td><strong>124</strong></td>
<td>0.00000038</td>
<td>0.00002</td>
</tr>
<tr>
<td><strong>30</strong></td>
<td>0.04616405</td>
<td>2.64501</td>
<td></td>
<td><strong>62</strong></td>
<td>0.00085675</td>
<td>0.04909</td>
<td></td>
<td><strong>94</strong></td>
<td>0.00000816</td>
<td>0.00047</td>
<td></td>
<td><strong>126</strong></td>
<td>0.00000031</td>
<td>0.00002</td>
</tr>
</tbody>
</table>
<p>Sources:</p>
<ul>
<li>RoFormer: Enhanced Transformer with Rotary Position Embedding: <a href="https://arxiv.org/abs/2104.09864v5" target="_blank">Paper</a> | <a href="https://paperswithcode.com/paper/roformer-enhanced-transformer-with-rotary" target="_blank">Papers with Code</a> | <a href="https://nn.labml.ai/transformers/rope/index.html" target="_blank">LabML Annotated Implementation</a></li>
<li>Llama 2: Open Foundation and Fine-Tuned Chat Models
: <a href="https://arxiv.org/abs/2307.09288" target="_blank">Paper</a></li>
<li>Llama: Open and Efficient Foundation Language Models
: <a href="https://arxiv.org/abs/2302.13971v1" target="_blank">Paper</a></li>
</ul>
<h2 id="104-getting-outer-product-of-frequency-tensor-and-position-indices"><strong>10.4. Getting Outer Product of Frequency Tensor and Position Indices</strong><a class="headerlink" href="#104-getting-outer-product-of-frequency-tensor-and-position-indices" title="Permanent link">&para;</a></h2>
<div class="language-py highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">import</span> <span class="nn">torch</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="k">def</span> <span class="nf">precompute_freqs_cis</span><span class="p">(</span><span class="n">dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">theta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">500000.0</span><span class="p">):</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>    <span class="o">...</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>    <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">freqs</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>    <span class="n">freqs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">freqs</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>    <span class="o">...</span>
</span></code></pre></div>
<p><sup>from <a href="https://github.com/adalkiran/llama-nuts-and-bolts/blob/main/src/model/llamatransformer.go" target="_blank">src/model/llamatransformer.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">precomputeFreqsCis</span><span class="p">(</span><span class="nx">dim</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">ml</span><span class="p">.</span><span class="nx">Tensor</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="o">...</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">    </span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ml</span><span class="p">.</span><span class="nx">ARange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">end</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">ml</span><span class="p">.</span><span class="nx">DT_BF16</span><span class="p">)</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">    </span><span class="o">...</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>The <code>end</code> is computed as <code>modelArgs.MaxSequenceLength*2</code>. In our case, <code>end = 2048 * 2 = 4096</code>.</p>
<blockquote>
<p><img alt="" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/26a0.svg" title=":warning:" /> Note for weirdnes here: In original implementation, <code>modelArgs.MaxSequenceLength</code> value is equal to <code>512</code> which is limitation for input prompt token count. With multiplying to 2, they've aimed to avoid of unnecessary calculations.<br>
However, in our implementation, we specified <code>modelArgs.MaxSequenceLength</code> as <code>2048</code>, and when we multiply it with 2, we get <code>4096</code>, an unnecessary and unmeaningful value. But I left it as it is, it doesn't hurt correctness, it causes only calculating unused unnecessary values.<br>
We will continue with 4096, but know that, it is unnecessarily high.<br>
On this issue, the original Python code has a comment (read this with considering this comment was taken from Llama 2 code, not Llama 3.1):<br></p>
</blockquote>
<div class="language-py highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># Note that self.params.max_seq_len is multiplied by 2 because the token limit for the Llama 2 generation of models is 4096. </span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="c1"># Adding this multiplier instead of using 4096 directly allows for dynamism of token lengths while training or fine-tuning.```</span>
</span></code></pre></div>
<p>At first, we generate a tensor named <code>t</code> with 4096 items as: <code>{0, 1, 2, 3, ..., 4093, 4094, 4095}</code>. This tensor contains our position indices.</p>
<p><sup>from <a href="https://github.com/adalkiran/llama-nuts-and-bolts/blob/main/src/model/llamatransformer.go" target="_blank">src/model/llamatransformer.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">precomputeFreqsCis</span><span class="p">(</span><span class="nx">dim</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">ml</span><span class="p">.</span><span class="nx">Tensor</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">    </span><span class="o">...</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span><span class="nx">freqs</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ml</span><span class="p">.</span><span class="nx">Outer</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">freqs</span><span class="p">)</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">    </span><span class="o">...</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>By calling <a href="https://github.com/adalkiran/llama-nuts-and-bolts/blob/main/src/ml/operations_impl.go" target="_blank">ml.Outer(t, freqs)</a> function, a tensor with shape <code>{4096, 64}</code> which is outer product of tensors <code>t with shape {4096}</code>and <code>freqs with shape {64}</code>.</p>
<p>This "outer product" function takes first argument as row vectors, second argument as column vectors.</p>
<p>In our case, we take items of <code>t</code> as rows, items of <code>freqs</code> as columns, then create 2D tensor called <code>result</code> as follows:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">row</th>
<th style="text-align: left;">column</th>
<th style="text-align: left;">set the result as</th>
<th>python equivalent (rad)</th>
<th>python equivalent (deg)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>t[0] = 0</code></td>
<td style="text-align: left;"><code>freqs[0] = 1.0000e+00</code></td>
<td style="text-align: left;"><code>result[0][0] = 0 * 1.0000e+00 = 0</code></td>
<td>0.00000</td>
<td>0.00000</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;"><code>freqs[1] = 8.1250e-01</code></td>
<td style="text-align: left;"><code>result[0][1] = 0 * 8.1250e-01 = 0</code></td>
<td>0.00000</td>
<td>0.00000</td>
</tr>
<tr>
<td style="text-align: left;">...</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align: left;"><code>t[1] = 1</code></td>
<td style="text-align: left;"><code>freqs[0] = 1.0000e+00</code></td>
<td style="text-align: left;"><code>result[1][0] = 1 * 1.0000e+00 = 1.0000e+00</code></td>
<td>1.00000000</td>
<td>57.29578</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;"><code>freqs[1] = 8.1250e-01</code></td>
<td style="text-align: left;"><code>result[1][1] = 1 * 8.1250e-01 = 8.1250e-01</code></td>
<td>0.81461722</td>
<td>46.67413</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;">...</td>
<td style="text-align: left;"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;"><code>freqs[62] = 3.7625e-07</code></td>
<td style="text-align: left;"><code>result[1][62] = 1 * 3.7625e-07 = 3.7625e-07</code></td>
<td>0.00000038</td>
<td>0.00002</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;"><code>freqs[63] = 3.0547e-07</code></td>
<td style="text-align: left;"><code>result[1][63] = 1 * 3.0547e-07 = 3.0547e-07</code></td>
<td>0.00000031</td>
<td>0.00002</td>
</tr>
<tr>
<td style="text-align: left;">...</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align: left;"><code>t[2] = 2</code></td>
<td style="text-align: left;"><code>freqs[0] = 1.0000e+00</code></td>
<td style="text-align: left;"><code>result[2][0] = 2 * 1.0000e+00 = 2.0000e+00</code></td>
<td>2.00000000</td>
<td>114.59155</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;"><code>freqs[1] = 8.1250e-01</code></td>
<td style="text-align: left;"><code>result[2][1] = 2 * 8.1250e-01 = 1.6250e+00</code></td>
<td>1.62923443</td>
<td>93.34825</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;">...</td>
<td style="text-align: left;"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;"><code>freqs[62] = 3.7625e-07</code></td>
<td style="text-align: left;"><code>result[2][62] = 2 * 3.7625e-07 = 7.5251e-07</code></td>
<td>0.00000075</td>
<td>0.00004</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;"><code>freqs[63] = 3.0547e-07</code></td>
<td style="text-align: left;"><code>result[2][63] = 2 * 3.0547e-07 = 6.1095e-07</code></td>
<td>0.00000061</td>
<td>0.00004</td>
</tr>
<tr>
<td style="text-align: left;">...</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align: left;"><code>t[4094] = 8190</code></td>
<td style="text-align: left;"><code>freqs[0] = 1.0000e+00</code></td>
<td style="text-align: left;"><code>result[4094][0] = 4094 * 1.0000e+00 = 4.0800e+03</code></td>
<td>4094.00000000</td>
<td>234568.90625 (normalized: -151.09375)</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;"> <code>freqs[1] = 8.1250e-01</code></td>
<td style="text-align: left;"><code>result[4094][1] = 4094 * 8.1250e-01 = 3.3120e+03</code></td>
<td>3335.04296875</td>
<td>191083.87500 (normalized: -76.12500)</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;">...</td>
<td style="text-align: left;"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;"><code>freqs[62] = 3.7625e-07</code></td>
<td style="text-align: left;"><code>result[4094][62] = 4094 * 3.7625e-07 = 1.5335e-03</code></td>
<td>0.00154234</td>
<td>0.08837</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;"><code>freqs[63] = 3.0547e-07</code></td>
<td style="text-align: left;"><code>result[4094][63] = 4094 * 3.0547e-07 = 1.2436e-03</code></td>
<td>0.00125642</td>
<td>0.07199</td>
</tr>
<tr>
<td style="text-align: left;">...</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align: left;"><code>t[4095] = 4095</code></td>
<td style="text-align: left;"><code>freqs[0] = 1.0000e+00</code></td>
<td style="text-align: left;"><code>result[4095][0] = 4095 * 1.0000e+00 = 4.0800e+03</code></td>
<td>4095.00000000</td>
<td>234626.20312 (normalized: -93.79688)</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;"><code>freqs[1] = 8.1250e-01</code></td>
<td style="text-align: left;"><code>result[4095][1] = 4095 * 8.1250e-01 = 3.3120e+03</code></td>
<td>3335.85742188</td>
<td>191130.54688 (normalized: -29.45312)</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;">...</td>
<td style="text-align: left;"></td>
<td></td>
<td></td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;"><code>freqs[62] = 3.7625e-07</code></td>
<td style="text-align: left;"><code>result[4095][62] = 4095 * 3.7625e-07 = 1.5335e-03</code></td>
<td>0.00154272</td>
<td>0.00154272</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;"><code>freqs[63] = 3.0547e-07</code></td>
<td style="text-align: left;"><code>result[4095][63] = 4095 * 3.0547e-07 = 1.2436e-03</code></td>
<td>0.00125673</td>
<td>0.07201</td>
</tr>
<tr>
<td style="text-align: left;"></td>
<td style="text-align: left;">...</td>
<td style="text-align: left;"></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><sup>from <a href="https://github.com/adalkiran/llama-nuts-and-bolts/blob/main/src/ml/operations_impl.go" target="_blank">src/ml/operations_impl.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">Outer</span><span class="p">(</span><span class="nx">vec1</span><span class="w"> </span><span class="o">*</span><span class="nx">Tensor</span><span class="p">,</span><span class="w"> </span><span class="nx">vec2</span><span class="w"> </span><span class="o">*</span><span class="nx">Tensor</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">Tensor</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">processErrors</span><span class="p">(</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">        </span><span class="nx">checkIsVector</span><span class="p">(</span><span class="nx">vec1</span><span class="p">),</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">        </span><span class="nx">checkIsVector</span><span class="p">(</span><span class="nx">vec2</span><span class="p">),</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">        </span><span class="nx">checkSameDataType</span><span class="p">(</span><span class="nx">vec1</span><span class="p">,</span><span class="w"> </span><span class="nx">vec2</span><span class="p">),</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">    </span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">    </span><span class="nx">itemSize</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">vec1</span><span class="p">.</span><span class="nx">DataType</span><span class="p">.</span><span class="nx">ItemSize</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">    </span><span class="nx">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">NewEmptyTensor</span><span class="p">([]</span><span class="kt">int</span><span class="p">{</span><span class="nx">vec1</span><span class="p">.</span><span class="nx">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="nx">vec2</span><span class="p">.</span><span class="nx">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span><span class="w"> </span><span class="nx">vec1</span><span class="p">.</span><span class="nx">DataType</span><span class="p">)</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">vec1</span><span class="p">.</span><span class="nx">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="w">        </span><span class="nx">rowValF32</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">vec1</span><span class="p">.</span><span class="nx">GetItemByOffset_AsFloat32</span><span class="p">(</span><span class="nx">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">itemSize</span><span class="p">)</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">vec2</span><span class="p">.</span><span class="nx">Size</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"> </span><span class="nx">j</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="w">            </span><span class="nx">colValF32</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">vec2</span><span class="p">.</span><span class="nx">GetItemByOffset_AsFloat32</span><span class="p">(</span><span class="nx">j</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">itemSize</span><span class="p">)</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="w">            </span><span class="nx">valF32</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">rowValF32</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">colValF32</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">SetItem_FromFloat32</span><span class="p">([]</span><span class="kt">int</span><span class="p">{</span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">j</span><span class="p">},</span><span class="w"> </span><span class="nx">valF32</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="p">}</span>
</span></code></pre></div>
<h2 id="105-calculating-frequency-tensor-as-cis-polar-coordinates"><strong>10.5. Calculating Frequency Tensor as Cis (Polar Coordinates)</strong><a class="headerlink" href="#105-calculating-frequency-tensor-as-cis-polar-coordinates" title="Permanent link">&para;</a></h2>
<p><a href="https://en.wikipedia.org/wiki/Cis_%28mathematics%29" target="_blank">cis</a> is described at Wikipedia:</p>
<blockquote>
<p>cis is a mathematical notation defined by cis x = cos x + i sin x,[nb 1] where cos is the cosine function, i is the imaginary unit and sin is the sine function. x is the argument of the complex number (angle between line to point and x-axis in polar form).</p>
</blockquote>
<div class="arithmatex">\[
\begin{gathered}
\text{where }i^2=-1, i\text{ is the imaginary unit,} \\
cis x = cos x + i \cdot sin x
\end{gathered}
\]</div>
<p>With this notation, we can express a point's location in cartesian coordinate system with cosine and sine of one angle, which is called as <a href="https://en.wikipedia.org/wiki/Polar_coordinate_system" target="_blank">polar coordinates</a>.</p>
<p>We've calculated angles of our polar coordinate points as <code>freqs</code> in previous chapter.</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="kn">import</span> <span class="nn">torch</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="k">def</span> <span class="nf">precompute_freqs_cis</span><span class="p">(</span><span class="n">dim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">theta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">500000.0</span><span class="p">):</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>    <span class="o">...</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a>    <span class="n">freqs_cis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">polar</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">freqs</span><span class="p">),</span> <span class="n">freqs</span><span class="p">)</span>  <span class="c1"># complex64</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a>    <span class="k">return</span> <span class="n">freqs_cis</span>
</span></code></pre></div>
<p><sup>from <a href="https://github.com/adalkiran/llama-nuts-and-bolts/blob/main/src/model/llamatransformer.go" target="_blank">src/model/llamatransformer.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">precomputeFreqsCis</span><span class="p">(</span><span class="nx">dim</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">ml</span><span class="p">.</span><span class="nx">Tensor</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="o">...</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">    </span><span class="nx">ones</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ml</span><span class="p">.</span><span class="nx">OnesLike</span><span class="p">(</span><span class="nx">freqs</span><span class="p">)</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">    </span><span class="nx">freqs_cis</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ml</span><span class="p">.</span><span class="nx">Polar</span><span class="p">(</span><span class="nx">ones</span><span class="p">,</span><span class="w"> </span><span class="nx">freqs</span><span class="p">)</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">freqs_cis</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="p">}</span>
</span></code></pre></div>
<p>We create a tensor which contains all <code>1</code> values with same shape <code>{4096, 64}</code> and data type as <code>freqs</code> tensor, via <a href="https://github.com/adalkiran/llama-nuts-and-bolts/blob/main/src/ml/operations_impl.go" target="_blank">ml.OnesLike(...))</a>. These  <code>1</code> values will be the magnitude of our vector in polar coordinate system. We use 1 for magnitude to get identity vector for the angle.</p>
<p>By calling <a href="https://github.com/adalkiran/llama-nuts-and-bolts/blob/main/src/ml/operations_impl.go" target="_blank">ml.Polar(ones, freqs)</a> function, a tensor with shape <code>{4096, 64}</code> which is outer product of tensors <code>t with shape {4096}</code>and <code>freqs with shape {64}</code> is got.</p>
<p><a href="https://pytorch.org/docs/stable/generated/torch.polar.html" target="_blank">Polar function</a> is described at Pytorch TORCH.POLAR documentation:</p>
<blockquote>
<p>Constructs a complex tensor whose elements are Cartesian coordinates corresponding to the polar coordinates with absolute value abs and angle.</p>
</blockquote>
<div class="arithmatex">\[
\begin{gathered}
\text{where }i^2=-1, i\text{ is the imaginary unit,} \\
out = abs \cdot \cos(angle) + abs \cdot \sin(angle) \cdot i
\end{gathered}
\]</div>
<p>In our case, the <code>abs</code> argument is a tensor full of <code>1</code> values. <code>angle</code> argument is our <code>freqs</code> variable.</p>
<p>For each item in the <code>angle</code> tensor:</p>
<ul>
<li>The cosine value of the angle is got, multiplied by <code>absItemF64 = 1</code> (it is always 1 in our case), set as the <em>real</em> part of the resulting complex number,</li>
<li>The sine value of the angle is got, multiplied by <code>absItemF64 = 1</code> (it is always 1 in our case), set as the <em>imaginary</em> part of the resulting complex number.</li>
</ul>
<p>Then, the <code>dst</code> tensor with <code>DT_COMPLEX</code> data type has cosine and sine values of our angles as complex numbers.</p>
<p><sup>from <a href="https://github.com/adalkiran/llama-nuts-and-bolts/blob/main/src/ml/operations_impl.go" target="_blank">src/ml/operations_impl.go</a></sup></p>
<div class="language-go highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">Polar</span><span class="p">(</span><span class="nx">abs</span><span class="w"> </span><span class="o">*</span><span class="nx">Tensor</span><span class="p">,</span><span class="w"> </span><span class="nx">angle</span><span class="w"> </span><span class="o">*</span><span class="nx">Tensor</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">Tensor</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">    </span><span class="c1">// See: (For formula) https://pytorch.org/docs/stable/generated/torch.polar.html</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">    </span><span class="o">...</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">readOffset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">readOffset</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">abs</span><span class="p">.</span><span class="nx">GetBytesCount</span><span class="p">();</span><span class="w"> </span><span class="nx">readOffset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">absItemSize</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">        </span><span class="nx">absItemF32</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">abs</span><span class="p">.</span><span class="nx">GetItemByOffset_AsFloat32</span><span class="p">(</span><span class="nx">readOffset</span><span class="p">)</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">        </span><span class="nx">angleItemF32</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">angle</span><span class="p">.</span><span class="nx">GetItemByOffset_AsFloat32</span><span class="p">(</span><span class="nx">readOffset</span><span class="p">)</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="w">        </span><span class="nx">absItemF64</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="nx">absItemF32</span><span class="p">)</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="w">        </span><span class="nx">angleItemF64</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="nx">angleItemF32</span><span class="p">)</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="w">        </span><span class="nx">realPart</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">absItemF64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">math</span><span class="p">.</span><span class="nx">Cos</span><span class="p">(</span><span class="nx">angleItemF64</span><span class="p">)</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="w">        </span><span class="nx">imagPart</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">absItemF64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">math</span><span class="p">.</span><span class="nx">Sin</span><span class="p">(</span><span class="nx">angleItemF64</span><span class="p">)</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="w">        </span><span class="nx">resultItem</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">complex64</span><span class="p">(</span><span class="nb">complex</span><span class="p">(</span><span class="nx">realPart</span><span class="p">,</span><span class="w"> </span><span class="nx">imagPart</span><span class="p">))</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">dst</span><span class="p">.</span><span class="nx">SetItemByOffset</span><span class="p">(</span><span class="nx">writeOffset</span><span class="p">,</span><span class="w"> </span><span class="nx">resultItem</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="w">        </span><span class="nx">writeOffset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">dstItemSize</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">dst</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a><span class="p">}</span>
</span></code></pre></div>
<p>In our case, with <code>1</code> is always as <code>absItemF64</code>:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">angleItemF64</th>
<th style="text-align: left;">realPart</th>
<th style="text-align: left;">imagPart</th>
<th style="text-align: left;">resultItem</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>freqs[0][0] = 0</code></td>
<td style="text-align: left;"><code>cos(0) = 1</code></td>
<td style="text-align: left;"><code>sin(0) = 0</code></td>
<td style="text-align: left;">(1 + 0i)</td>
</tr>
<tr>
<td style="text-align: left;"><code>freqs[0][1] = 0</code></td>
<td style="text-align: left;"><code>cos(0) = 1</code></td>
<td style="text-align: left;"><code>sin(0) = 0</code></td>
<td style="text-align: left;">(1 + 0i)</td>
</tr>
<tr>
<td style="text-align: left;">...</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><code>freqs[1][0] = 1</code></td>
<td style="text-align: left;"><code>cos(1) = 0.5403023</code></td>
<td style="text-align: left;"><code>sin(1) = 0.84147096</code></td>
<td style="text-align: left;">(0.5403023 + 0.84147096i)</td>
</tr>
<tr>
<td style="text-align: left;">...</td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><code>freqs[4095][63] = 0.0012436</code></td>
<td style="text-align: left;"><code>cos(0.0012436) = 1</code></td>
<td style="text-align: left;"><code>sin(0.0012436) = 0.0012436</code></td>
<td style="text-align: left;">(1 + 0.0012436i)</td>
</tr>
</tbody>
</table>
<h2 id="106-the-result"><strong>10.6. The result</strong><a class="headerlink" href="#106-the-result" title="Permanent link">&para;</a></h2>
<p>Recap of what we have so far:</p>
<ul>
<li>An embedding layer with the shape of <code>{128256, 4096}</code>, that contains vectors that have <code>4096</code> dimensions each, <code>128256</code> different token vectors.</li>
<li>A token embedding sequence which was calculated using the embedding layer. Our input tensor will be with the shape of <code>{SequenceLength, 4096}</code>,</li>
<li>We have <code>32</code> "attention heads" (according to <code>modelArgs.N_Heads = 32</code>). Our each attention head will have a dimension <code>modelArgs.Dim / modelArgs.N_Heads</code>. In our case, it is <code>4096 / 32 = 128</code>. So our positional embedding tensors will have <code>128</code> dimensions.</li>
<li>Because of we have <code>32</code> attention heads and the dimesion of our each attention head is <code>128</code>, we will separate our <code>xq (queries)</code> matrix into 32 equal pieces, then because of we have <code>8</code> key/value heads, we will separate our <code>xk (keys)</code>matrix into 8 equal pieces, that end up with <code>128</code> at one dimension. Then, the integration with positional embeddings and the token embeddings is done on <code>128</code> dimension.</li>
<li>Think of, we have 5 tokens to encode, so we have position indices of the tokens: <code>{1, 2, 3, 4, 5}</code>.</li>
</ul>
<p>After all of these processes, we will end up with a "positional encoding tensor" for a sequence having <code>5</code> positions as follows:</p>
<blockquote>
<p>Note: The <span class="arithmatex">\(\LaTeX\)</span> support of Github web app lacks and gives non-explanatory errors when you have more than a limit of superscipts/subscripts/fraction notations. So, it was a must to separate the biggest set notation into chunks.</p>
</blockquote>
<p>The operation of <code>applyScaling(...)</code> function is represented with <code>scl(...)</code>.</p>
<div class="arithmatex">\[
PE = \left\lbrace
\begin{array}{l}
p_{pos,2i} = \sin\left(pos \cdot scl\left(\frac{1}{500000^\frac{2i}{d_{model}}}\right)\right) \\
\\
p_{pos,2i+1} = \cos\left(pos \cdot scl\left(\frac{1}{500000^\frac{2i}{d_{model}}}\right)\right) \\
\end{array}
\right\rbrace
\]</div>
<ul>
<li>Positional Encoding tensor for 5 positions, without converting to complex number:</li>
</ul>
<div class="arithmatex">\[
\begin{gathered}
\text{where }PE_{pos,i} \in \mathbb{R}^{dim = 128}, \\
\\
PE = \left\lbrack
\begin{array}{l}
    PE_{pos0}, PE_{pos1}, PE_{pos2}, PE_{pos3}, PE_{pos4}
\end{array}
\right\rbrack
\end{gathered}
\]</div>
<p><br></p>
<div class="arithmatex">\[
\begin{gathered}
    PE_{pos0}=
    \left\lbrace
    \begin{array}{l}
        \sin\left(scl\left(\frac{0}{500000^{\frac{0}{128}}}\right)\right),
        \cos\left(scl\left(\frac{0}{500000^{\frac{0}{128}}}\right)\right),
        \sin\left(scl\left(\frac{0}{500000^{\frac{2}{128}}}\right)\right),
        \cos\left(scl\left(\frac{0}{500000^{\frac{2}{128}}}\right)\right),
        \sin\left(scl\left(\frac{0}{500000^{\frac{4}{128}}}\right)\right),
        \cos\left(scl\left(\frac{0}{500000^{\frac{4}{128}}}\right)\right),
        \dots, \\\\
        \sin\left(scl\left(\frac{0}{500000^{\frac{124}{128}}}\right)\right),
        \cos\left(scl\left(\frac{0}{500000^{\frac{124}{128}}}\right)\right),
        \sin\left(scl\left(\frac{0}{500000^{\frac{126}{128}}}\right)\right),
        \cos\left(scl\left(\frac{0}{500000^{\frac{126}{128}}}\right)\right)
    \end{array}
    \right\rbrace \\
\end{gathered}
\]</div>
<div class="arithmatex">\[
\begin{gathered}
    PE_{pos1}=
    \left\lbrace
    \begin{array}{l}
        \sin\left(scl\left(\frac{1}{500000^{\frac{0}{128}}}\right)\right),
        \cos\left(scl\left(\frac{1}{500000^{\frac{0}{128}}}\right)\right),
        \sin\left(scl\left(\frac{1}{500000^{\frac{2}{128}}}\right)\right),
        \cos\left(scl\left(\frac{1}{500000^{\frac{2}{128}}}\right)\right),
        \sin\left(scl\left(\frac{1}{500000^{\frac{4}{128}}}\right)\right),
        \cos\left(scl\left(\frac{1}{500000^{\frac{4}{128}}}\right)\right),
        \dots, \\\\
        \sin\left(scl\left(\frac{1}{500000^{\frac{124}{128}}}\right)\right),
        \cos\left(scl\left(\frac{1}{500000^{\frac{124}{128}}}\right)\right),
        \sin\left(scl\left(\frac{1}{500000^{\frac{126}{128}}}\right)\right),
        \cos\left(scl\left(\frac{1}{500000^{\frac{126}{128}}}\right)\right)
    \end{array}
    \right\rbrace \\
\end{gathered}
\]</div>
<div class="arithmatex">\[
\begin{gathered}
    PE_{pos2}=
    \left\lbrace
    \begin{array}{l}
        \sin\left(scl\left(\frac{2}{500000^{\frac{0}{128}}}\right)\right),
        \cos\left(scl\left(\frac{2}{500000^{\frac{0}{128}}}\right)\right),
        \sin\left(scl\left(\frac{2}{500000^{\frac{2}{128}}}\right)\right),
        \cos\left(scl\left(\frac{2}{500000^{\frac{2}{128}}}\right)\right),
        \sin\left(scl\left(\frac{2}{500000^{\frac{4}{128}}}\right)\right),
        \cos\left(scl\left(\frac{2}{500000^{\frac{4}{128}}}\right)\right),
        \dots, \\\\
        \sin\left(scl\left(\frac{2}{500000^{\frac{124}{128}}}\right)\right),
        \cos\left(scl\left(\frac{2}{500000^{\frac{124}{128}}}\right)\right),
        \sin\left(scl\left(\frac{2}{500000^{\frac{126}{128}}}\right)\right),
        \cos\left(scl\left(\frac{2}{500000^{\frac{126}{128}}}\right)\right)
    \end{array}
    \right\rbrace \\
\end{gathered}
\]</div>
<div class="arithmatex">\[
\begin{gathered}
    PE_{pos3}=
    \left\lbrace
    \begin{array}{l}
        \sin\left(scl\left(\frac{3}{500000^{\frac{0}{128}}}\right)\right),
        \cos\left(scl\left(\frac{3}{500000^{\frac{0}{128}}}\right)\right),
        \sin\left(scl\left(\frac{3}{500000^{\frac{2}{128}}}\right)\right),
        \cos\left(scl\left(\frac{3}{500000^{\frac{2}{128}}}\right)\right),
        \sin\left(scl\left(\frac{3}{500000^{\frac{4}{128}}}\right)\right),
        \cos\left(scl\left(\frac{3}{500000^{\frac{4}{128}}}\right)\right),
        \dots, \\\\
        \sin\left(scl\left(\frac{3}{500000^{\frac{124}{128}}}\right)\right),
        \cos\left(scl\left(\frac{3}{500000^{\frac{124}{128}}}\right)\right),
        \sin\left(scl\left(\frac{3}{500000^{\frac{126}{128}}}\right)\right),
        \cos\left(scl\left(\frac{3}{500000^{\frac{126}{128}}}\right)\right)
    \end{array}
    \right\rbrace \\
\end{gathered}
\]</div>
<div class="arithmatex">\[
\begin{gathered}
    PE_{pos4}=
    \left\lbrace
    \begin{array}{l}
        \sin\left(scl\left(\frac{4}{500000^{\frac{0}{128}}}\right)\right),
        \cos\left(scl\left(\frac{4}{500000^{\frac{0}{128}}}\right)\right),
        \sin\left(scl\left(\frac{4}{500000^{\frac{2}{128}}}\right)\right),
        \cos\left(scl\left(\frac{4}{500000^{\frac{2}{128}}}\right)\right),
        \sin\left(scl\left(\frac{4}{500000^{\frac{4}{128}}}\right)\right),
        \cos\left(scl\left(\frac{4}{500000^{\frac{4}{128}}}\right)\right),
        \dots, \\\\
        \sin\left(scl\left(\frac{4}{500000^{\frac{124}{128}}}\right)\right),
        \cos\left(scl\left(\frac{4}{500000^{\frac{124}{128}}}\right)\right),
        \sin\left(scl\left(\frac{4}{500000^{\frac{126}{128}}}\right)\right),
        \cos\left(scl\left(\frac{4}{500000^{\frac{126}{128}}}\right)\right)
    \end{array}
    \right\rbrace \\
\end{gathered}
\]</div>
<p><br><br></p>
<ul>
<li>Positional Encoding tensor for 5 positions, after converting to complex number:</li>
</ul>
<div class="arithmatex">\[
\begin{gathered}
\text{where }PE_{pos,i} \in \mathbb{C}^{\frac{dim}{2} = 64}, i^2=-1, i\text{ is the imaginary unit,}
\\
\\
PE = \left\lbrack
\begin{array}{l}
    PE_{pos0}, PE_{pos1}, PE_{pos2}, PE_{pos3}, PE_{pos4}
\end{array}
\right\rbrack
\end{gathered}
\]</div>
<p><br></p>
<div class="arithmatex">\[
\begin{gathered}
    PE_{pos0}=
    \left\lbrace
    \begin{array}{l}
        \sin\left(scl\left(\frac{0}{500000^{\frac{0}{128}}}\right)\right) + i \cos\left(scl\left(\frac{0}{500000^{\frac{0}{128}}}\right)\right),
        \sin\left(scl\left(\frac{0}{500000^{\frac{2}{128}}}\right)\right) + i \cos\left(scl\left(\frac{0}{500000^{\frac{2}{128}}}\right)\right),
        \sin\left(scl\left(\frac{0}{500000^{\frac{4}{128}}}\right)\right) + i \cos\left(scl\left(\frac{0}{500000^{\frac{4}{128}}}\right)\right),
        \dots, \\\\
        \sin\left(scl\left(\frac{0}{500000^{\frac{124}{128}}}\right)\right) + i \cos\left(scl\left(\frac{0}{500000^{\frac{124}{128}}}\right)\right),
        \sin\left(scl\left(\frac{0}{500000^{\frac{126}{128}}}\right)\right) + i \cos\left(scl\left(\frac{0}{500000^{\frac{126}{128}}}\right)\right)
    \end{array}
    \right\rbrace \\
\end{gathered} \\\\
\]</div>
<div class="arithmatex">\[
\begin{gathered}
    PE_{pos1}=
    \left\lbrace
    \begin{array}{l}
        \sin\left(scl\left(\frac{1}{500000^{\frac{0}{128}}}\right)\right) + i \cos\left(scl\left(\frac{1}{500000^{\frac{0}{128}}}\right)\right),
        \sin\left(scl\left(\frac{1}{500000^{\frac{2}{128}}}\right)\right) + i \cos\left(scl\left(\frac{1}{500000^{\frac{2}{128}}}\right)\right),
        \sin\left(scl\left(\frac{1}{500000^{\frac{4}{128}}}\right)\right) + i \cos\left(scl\left(\frac{1}{500000^{\frac{4}{128}}}\right)\right),
        \dots, \\\\
        \sin\left(scl\left(\frac{1}{500000^{\frac{124}{128}}}\right)\right) + i \cos\left(scl\left(\frac{1}{500000^{\frac{124}{128}}}\right)\right),
        \sin\left(scl\left(\frac{1}{500000^{\frac{126}{128}}}\right)\right) + i \cos\left(scl\left(\frac{1}{500000^{\frac{126}{128}}}\right)\right)
    \end{array}
    \right\rbrace \\\\
\end{gathered} \\
\]</div>
<div class="arithmatex">\[
\begin{gathered}
    PE_{pos2}=
    \left\lbrace
    \begin{array}{l}
        \sin\left(scl\left(\frac{2}{500000^{\frac{0}{128}}}\right)\right) + i \cos\left(scl\left(\frac{2}{500000^{\frac{0}{128}}}\right)\right),
        \sin\left(scl\left(\frac{2}{500000^{\frac{2}{128}}}\right)\right) + i \cos\left(scl\left(\frac{2}{500000^{\frac{2}{128}}}\right)\right),
        \sin\left(scl\left(\frac{2}{500000^{\frac{4}{128}}}\right)\right) + i \cos\left(scl\left(\frac{2}{500000^{\frac{4}{128}}}\right)\right),
        \dots, \\\\
        \sin\left(scl\left(\frac{2}{500000^{\frac{124}{128}}}\right)\right) + i \cos\left(scl\left(\frac{2}{500000^{\frac{124}{128}}}\right)\right),
        \sin\left(scl\left(\frac{2}{500000^{\frac{126}{128}}}\right)\right) + i \cos\left(scl\left(\frac{2}{500000^{\frac{126}{128}}}\right)\right)
    \end{array}
    \right\rbrace \\\\
\end{gathered} \\
\]</div>
<div class="arithmatex">\[
\begin{gathered}
    PE_{pos3}=
    \left\lbrace
    \begin{array}{l}
        \sin\left(scl\left(\frac{3}{500000^{\frac{0}{128}}}\right)\right) + i \cos\left(scl\left(\frac{3}{500000^{\frac{0}{128}}}\right)\right),
        \sin\left(scl\left(\frac{3}{500000^{\frac{2}{128}}}\right)\right) + i \cos\left(scl\left(\frac{3}{500000^{\frac{2}{128}}}\right)\right),
        \sin\left(scl\left(\frac{3}{500000^{\frac{4}{128}}}\right)\right) + i \cos\left(scl\left(\frac{3}{500000^{\frac{4}{128}}}\right)\right),
        \dots, \\\\
        \sin\left(scl\left(\frac{3}{500000^{\frac{124}{128}}}\right)\right) + i \cos\left(scl\left(\frac{3}{500000^{\frac{124}{128}}}\right)\right),
        \sin\left(scl\left(\frac{3}{500000^{\frac{126}{128}}}\right)\right) + i \cos\left(scl\left(\frac{3}{500000^{\frac{126}{128}}}\right)\right)
    \end{array}
    \right\rbrace \\
\end{gathered} \\\\
\]</div>
<div class="arithmatex">\[
\begin{gathered}
    PE_{pos4}=
    \left\lbrace
    \begin{array}{l}
        \sin\left(scl\left(\frac{4}{500000^{\frac{0}{128}}}\right)\right) + i \cos\left(scl\left(\frac{4}{500000^{\frac{0}{128}}}\right)\right),
        \sin\left(scl\left(\frac{4}{500000^{\frac{2}{128}}}\right)\right) + i \cos\left(scl\left(\frac{4}{500000^{\frac{2}{128}}}\right)\right),
        \sin\left(scl\left(\frac{4}{500000^{\frac{4}{128}}}\right)\right) + i \cos\left(scl\left(\frac{4}{500000^{\frac{4}{128}}}\right)\right),
        \dots, \\\\
        \sin\left(scl\left(\frac{4}{500000^{\frac{124}{128}}}\right)\right) + i \cos\left(scl\left(\frac{4}{500000^{\frac{124}{128}}}\right)\right),
        \sin\left(scl\left(\frac{4}{500000^{\frac{126}{128}}}\right)\right) + i \cos\left(scl\left(\frac{4}{500000^{\frac{126}{128}}}\right)\right)
    \end{array}
    \right\rbrace \\
\end{gathered} \\
\]</div>
<h2 id="107-visualized-form-of-some-samples-from-the-frequency-tensor"><strong>10.7. Visualized Form of Some Samples from The Frequency Tensor</strong><a class="headerlink" href="#107-visualized-form-of-some-samples-from-the-frequency-tensor" title="Permanent link">&para;</a></h2>
<p>The charts below aim to give you some insight into the values of angles and corresponding polar coordinates in the frequency tensor. The chart titles contain which index ranges are taken as samples in a particular chart.</p>
<p>These charts are drawn to make it easy for you to compare changes between positions and dimensions.</p>
<blockquote>
<p>You can check out the Python codes that create the sample data and charts used here with this Python Notebook: <a href="https://github.com/adalkiran/llama-nuts-and-bolts/blob/main/docs/10.BONUS-PRECOMPUTING-FREQUENCY-TENSOR.ipynb" target="_blank">10.BONUS-PRECOMPUTING-FREQUENCY-TENSOR.ipynb</a></p>
</blockquote>
<p>3D charts of polar coordinates:</p>
<p><img alt="Chart 3D - Polar coordinates of 0th position" src="../images/03-chart_polar_coordinates_3d_pos_0.svg" />
<img alt="Chart 3D - Polar coordinates of 1st position" src="../images/03-chart_polar_coordinates_3d_pos_1.svg" />
<img alt="Chart 3D - Polar coordinates of 2nd position" src="../images/03-chart_polar_coordinates_3d_pos_2.svg" />
<img alt="Chart 3D - Polar coordinates of 5th position" src="../images/03-chart_polar_coordinates_3d_pos_5.svg" />
<img alt="Chart 3D - Polar coordinates of 10th position" src="../images/03-chart_polar_coordinates_3d_pos_10.svg" />
<img alt="Chart 3D - Polar coordinates of 300th position" src="../images/03-chart_polar_coordinates_3d_pos_300.svg" />
<img alt="Chart 3D - Polar coordinates of 301st position" src="../images/03-chart_polar_coordinates_3d_pos_301.svg" />
<img alt="Chart 3D - Polar coordinates of 1000th position" src="../images/03-chart_polar_coordinates_3d_pos_1000.svg" /></p>
<p>2D charts of angles:</p>
<p><img alt="Chart - Angles per sample positions and dimensions" src="../images/03-chart_angles_2d.svg" /></p>







  
  



  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../09-IMPLEMENTING-LLAMA-MODEL-ARCHITECTURE/" class="md-footer__link md-footer__link--prev" aria-label="Previous: IMPLEMENTING LLAMA MODEL ARCHITECTURE">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                IMPLEMENTING LLAMA MODEL ARCHITECTURE
              </div>
            </div>
          </a>
        
        
          
          <a href="../11-ASKING-FOR-USER-INPUT/" class="md-footer__link md-footer__link--next" aria-label="Next: ASKING FOR USER INPUT">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                ASKING FOR USER INPUT
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 - present, Adil Alper DALKIRAN. All rights reserved.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://github.com/adalkiran" target="_blank" rel="noopener" title="adalkiran" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://www.linkedin.com/in/alper-dalkiran/" target="_blank" rel="noopener" title="@aadalkiran" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8l164.9-188.5L26.8 48h145.6l100.5 132.9L389.2 48zm-24.8 373.8h39.1L151.1 88h-42l255.3 333.8z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://www.linkedin.com/in/alper-dalkiran/" target="_blank" rel="noopener" title="in/alper-dalkiran" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["toc.follow", "toc.integrate", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "navigation.footer", "content.code.copy"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>